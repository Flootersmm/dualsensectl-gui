use crate::custom_button::CustomButton;
use crate::dualsensectl::*;
use crate::gui::utils::*;
use crate::save::*;

use gtk::glib::Propagation;
use gtk::prelude::*;
use gtk::Button;
use gtk::{Application, ApplicationWindow, Box, Orientation};
use gtk::ComboBox;
use gtk::ListStore;
pub fn build_ui(app: &Application) -> ApplicationWindow {
    let app_state = load_state();

    let (lightbar_box, lightbar_switch) =
        create_labeled_switch("Lightbar", app_state.lightbar_enabled);

    let (battery_box, battery_level_bar) =
        create_labeled_level_bar("Battery", app_state.battery_percentage, 0.0, 100.0);

    let refresh_button = Button::builder()
        .label("Refresh")
        .margin_top(6)
        .margin_bottom(12)
        .build();
    battery_box.append(&refresh_button);

    let playerleds_dropdown = ComboBoxText::new();
    for i in 0..=5 {
        playerleds_dropdown.append(Some(&i.to_string()), &i.to_string());
    }

    playerleds_dropdown.set_active(Some(app_state.playerleds as u32)); // Set initial value

    let submit_button = Button::builder()
        .label("Submit")
        .margin_top(6)
        .margin_bottom(12)
        .build();
    let playerleds_box = Box::builder()
        .orientation(Orientation::Vertical)
        .spacing(6)
        .halign(gtk::Align::Center)
        .build();
    playerleds_box.append(&playerleds_dropdown);
    playerleds_box.append(&submit_button);

    let playerleds_entry_clone = playerleds_entry.clone();
    let lightbar_switch_clone = lightbar_switch.clone();
    let battery_level_bar_clone = battery_level_bar.clone();

    submit_button.connect_clicked(move |_| {
        if let Ok(playerleds) = playerleds_entry_clone.text().trim().parse::<u32>() {
            if (0..=5).contains(&playerleds) {
                change_playerleds(playerleds);
            } else {
                eprintln!(
                    "Invalid player LEDs value: {}. Must be between 0 and 5.",
                    playerleds
                );
            }
        } else {
            eprintln!("Invalid input for player LEDs.");
        }
    });

    refresh_button.connect_clicked(move |_| {
        let battery_percentage = report_battery()
            .trim_end_matches('%')
            .parse::<f64>()
            .unwrap_or(0.0);
        battery_level_bar_clone.set_value(battery_percentage);

        // Save the updated state
        let new_state = AppState {
            lightbar_enabled: lightbar_switch_clone.is_active(),
            battery_percentage,
            playerleds: 1,
        };
        if let Err(err) = save_state(&new_state) {
            eprintln!("Failed to save state: {}", err);
        }
    });

    let battery_level_bar_clone = battery_level_bar.clone();
    lightbar_switch.connect_state_set(move |_, state| {
        toggle_lightbar(state);
        let new_state = AppState {
            lightbar_enabled: state,
            battery_percentage: battery_level_bar_clone.value(),
            playerleds: 1,
        };
        if let Err(err) = save_state(&new_state) {
            eprintln!("Failed to save state: {}", err);
        }
        Propagation::Proceed
    });

    let hbox = Box::builder()
        .orientation(Orientation::Horizontal)
        .spacing(20)
        .halign(gtk::Align::Center)
        .build();
    hbox.append(&lightbar_box);
    hbox.append(&battery_box);

    let vbox = Box::builder()
        .orientation(Orientation::Vertical)
        .spacing(10)
        .margin_top(12)
        .margin_bottom(12)
        .margin_start(12)
        .margin_end(12)
        .build();
    vbox.append(&hbox);
    vbox.append(&playerleds_box);

    let window = ApplicationWindow::builder()
        .application(app)
        .title("Dualsensectl GUI")
        .child(&vbox)
        .build();

    let battery_level_bar_clone = battery_level_bar.clone();
    let lightbar_switch_clone = lightbar_switch.clone();
    let playerleds_entry_clone = playerleds_entry.clone();
    window.connect_close_request(move |win| {
        let final_state = AppState {
            lightbar_enabled: lightbar_switch_clone.is_active(),
            battery_percentage: battery_level_bar_clone.value(),
            playerleds: playerleds_entry_clone
                .text()
                .trim()
                .parse::<u32>()
                .unwrap_or(0),
        };
        if let Err(err) = save_state(&final_state) {
            eprintln!("Failed to save state: {}", err);
        }
        win.close();
        Propagation::Proceed
    });

    window
}
